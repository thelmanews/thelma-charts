<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="th-d3-chart.html">

<polymer-element name="th-split-donut-chart" extends="th-d3-chart">
  <template>
    <style>

      :host {
        display: inline-block;
        position: relative;
      }

      #chart text {
        font-size: 14px;
      }
      
    </style>

      <svg id="chart"></svg>
  </template>
  <script>

      Polymer('th-split-donut-chart', {
        chartData: {value1: 26, value2: 43 },
        colors: { foreground: "#fff" , background: "#eee", accents: ["#00c3d9", "#1f77b4"]},
        init: function() {
          var that = this,
              margin = {
                top : 10,
                right : 0,
                bottom : 10,
                left : 0,
                label: 3
              }, 
              width = that.chartWidth*0.95 - margin.left - margin.right, height = that.chartHeight*0.95 - margin.top - margin.bottom,
              pi = Math.PI,
              progress = 0,
              total = 100,
              formatPercent = d3.format(".0%"),
              outerRadius = height*0.39,
              innerRadius = height*0.25;
              this._prevProgress = 0;

            var data = [that.chartData.value1, that.chartData.value2];
            that.height = height;
            

            var foreground, foreground2, text, arc, circle;

            arc = d3.svg.arc()
              .startAngle(0*(Math.PI/180))
              .endAngle(180*(Math.PI/180))
              .innerRadius(innerRadius)
              .outerRadius(outerRadius);

            var chart_svg = that.$.chart;
            var svg = d3.select(chart_svg);

            var container = svg.attr("width", width)
                .attr("height", height)
                .append("g")
                .attr("transform", "translate(" +(width / 2 ) + "," + (height / 2) + ")");
            
            var meter = container.append("g")
                .attr("class", "progress-meter");
            
            meter.selectAll("path.background")
                .data(data)
                .enter()
                  .append("path")
                  .attr("fill", that.colors.foreground)
                  .attr("class", "background")
                  .attr("transform", function(d,i){
                    return i > 0 ? "translate(0, 5) rotate(90) scale(1,-1)" : "rotate(90) scale(-1,-1)";
                  })
                  .attr("d", arc);
            
            foreground = meter.selectAll("path.foreground")
                .data(data)
                .enter()
                  .append("path")
                  .attr("fill", function(d,i){
                    return that.colors.accents[i];
                  })
                  .attr("stroke", function(d,i){
                    return that.colors.accents[i];
                  })
                  .attr("class", "foreground")
                  .attr("transform", function(d,i){
                    return i > 0 ? "translate(0, 5) rotate(90) scale(1,-1)" : "rotate(90) scale(-1,-1)";
                  });
            
            text = meter.selectAll("text.label")
                .data(data)
                .enter()
                  .append("text")
                  .attr("class", "label")
                  .attr("fill", function(d,i){
                    return that.colors.accents[i];
                  })
                  .attr("text-anchor", "middle")
                  .attr("dy", function(d,i){
                    return i > 0 ? "2em" : "-1.5em";
                  });

            this.foreground = foreground;
            this.formatPercent = formatPercent;
            this.arc = arc;
            this.pi = pi;
            this.text = text;
            this.data = data;
            this.meter = meter;



        },
        reset: function() {
            
            
        },
        
        animate: function() {

              var total = 100;
              var that = this;
              var data = this.data;
              var meter = this.meter;
         
              // var i = d3.interpolate(that._prevProgress/total, progress/total);//d3.event.loaded / total);
              
              
              // d3.transition().delay(1000).duration(1000)
              //   .tween("progress", function() {
              //     return function(t) {
              //       progress = i(t);
              //       that.foreground.attr("d", that.arc.endAngle(that.pi * progress));
              //       that.text.text(that.formatPercent(progress));
              //     };
              //   });
              //   // .tween("progress2", function() {
              //   //   return function(t) {
              //   //     progress2 = j(t);
              //   //     that.foreground2.attr("d", that.arc.endAngle(that.pi * progress2));
              //   //     that.text2.text(that.formatPercent(progress2));
              //   //   };
              //   // });
  
              meter.selectAll("path.foreground").transition().delay(1000).duration(1000)
                .attrTween('d', function(d){
                  var i = d3.interpolate(that._prevProgress/total, d/total);
                  
                  // console.log(d);
                  return function(t) {
                    var progress = i(t);
                    console.log("*^*^*^**^")
                    console.log(progress);
                    meter.selectAll("text.label").text(function(d){
return that.formatPercent(progress);
                   
                    })
                    // that.text.text(that.formatPercent(progress));
                    return that.arc.endAngle(that.pi * progress)();
                    
                  };
                })
              this._prevProgress = progress; 


        }
        
      });



  </script>
</polymer-element>