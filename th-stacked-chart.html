<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="th-d3-chart.html">


<polymer-element name="th-statcked-chart" extends="th-d3-chart">
	<script>

		Polymer('th-statcked-chart', {

		  init: function() {
		    var margin = {
		          top : 5,
		          right : 0,
		          bottom : 10,
		          left : 0,
		          label: 3
		      }, width = this.chartWidth*0.95 - margin.left - margin.right, height = this.chartHeight*0.55 - margin.top - margin.bottom
		         , barWidth = width* 0.12 , textLabelMargin = height*0.05;

		      this.height = height;

		      this.x = d3.scale.ordinal().rangeRoundBands([0, width], .1);

		      var y = d3.scale.linear().range([0, height]);
		      this.y = y;

		      var chart_svg = this.$.chart;

		      var colors = d3.scale.category10();
		      colors.domain(this.chartData.length);

		      console.log(d3.select(chart_svg));
		      this.container = d3.select(chart_svg).attr('width', width + margin.left + margin.right)
		          .attr('height', height + margin.top + margin.bottom)
		          .append('g')
		          .attr('transform', 'translate(' + margin.left + ',' + margin.top + ')');

		      var total = 0;
		      this.chartData.forEach(function(d) {
		          d.total = total;
		          total+=d.value;
		          console.log(d);
		      });
		      
		      y.domain([0, total]); 


		      this.bars = this.container.selectAll('.bar').data(this.chartData).enter().append('rect').attr('class','bar');
		      //console.log(this.bars);
		      this.bars
		        .style('fill', function(d,i) {return d.color ? d.color : colors(i);})
		        .attr('x', width/2 - barWidth/2)
		        //.attr('y', 0)
		        .attr('y', height)
		        .attr('width',barWidth)
		        .attr('height', 0);

		      this.labels = this.container.selectAll('.label').data(this.chartData).enter().append('text').attr('class','label');
		      //console.log(this.bars);
		      this.labels
		        .style('fill', function(d,i) {return d.color ? d.color : colors(i);})
		        .style('opacity', 0)
		        .style('text-anchor','end')
		        .attr('x', width/2 - barWidth/2 - margin.label)
		        .attr('y', height) //12: font size
		        .text(function(d) {return d.label;});
		      
		      this.values = this.container.selectAll('.value').data(this.chartData).enter().append('text').attr('class','value');
		      //console.log(this.bars);
		      this.values
		        .style('fill', function(d,i) {return d.color ? d.color : colors(i);})
		        .style('opacity', 0)
		        .attr('x', width/2 + barWidth/2 + margin.label)
		        .attr('y', height) //12: font size
		        .text(function(d) {return d.display_value ? d.display_value : d.value ;});


		  },
		  reset: function() {
		      
		      var height= this.height;
		      this.bars.transition().duration(this.animationDelay).attr('y', height).attr('height', 0);
		      this.labels.transition().duration(this.animationDelay).attr('y', height ).style('opacity', 0);
		      this.values.transition().duration(this.animationDelay).attr('y', height ).style('opacity', 0);
		      
		  },
		  
		  animate: function() {

		        var y = this.y;
		        console.log(this.animationDelay)
		        this.bars.transition().duration(this.animationDelay)//.delay(function(d,i) { return i*this.animationDelay;})
		        .attr('y', function(d) {return y(d.total)})
		        .attr('height', function(d) {return y(d.value)});

		        this.labels.transition(this.animationDelay).duration(this.animationDelay)//.delay(function(d,i) { return i*this.animationDelay;})
		        .style('opacity', 1)
		        .attr('y', function(d) {return y(d.total) + 12 }); //12: font size
		        
		        this.values.transition(this.animationDelay).duration(this.animationDelay)//.delay(function(d,i) { return i*this.animationDelay;})
		        .style('opacity', 1)
		        .attr('y', function(d) {return y(d.total) + 12 }); //12: font size

		  },
		  chartSpecificDataValidate: function() {
		  		// There should be at least one set.
		  		// Each set should have a label and value.
		  		// There cannot be negative numbers.

          var errors = [],
              numOfSets = this.chartData.length,
              valuesCheck = true,
              labelsCheck = true,
              positivesCheck = true;

          for (var i=0; i < numOfSets; i++){
          	if (!this.chartData[i].value){ 
          		valuesCheck = false; 
          	} else if (this.chartData[i].value < 0){
          		positivesCheck = false;
          	}
          	if (!this.chartData[i].label){ 
          		labelsCheck = false; 
          	}
          }
							
          if(numOfSets === 0) {
            errors.push({input: numOfSets, msg: 'Please include at least one value and label.'});
          } else {
          		if (!valuesCheck){
            		errors.push({ input: this.chartData, msg: 'You must include a value for each set.'});
          		}
          		if (!labelsCheck){
          			errors.push({ input: this.chartData, msg: 'You must include an label for each value.'});	
          		}
          		if (!positivesCheck){
          			errors.push({ input: this.chartData, msg: 'You cannot have any negative values.'});	
          		}
        	}
        
          return errors;
        }
		  
		  
		});

	</script>
</polymer-element>
