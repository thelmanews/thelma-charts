<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="th-d3-chart.html">

<polymer-element name="th-line-graph" extends="th-d3-chart" attributes="line-style">
  <template>
    <style>
      :host {
        font-size: 0.875em;
        color: white;
      }
       
      line {
        stroke: #386c9d;
        stroke-width: 2;
      }
      #chart {
        width: 100%;
        padding: 10px;
        box-sizing: border-box;
      }
      .xTicks, .yTicks {
        stroke: #386c9d;
      }

      .xLabel, .yLabel {
        font-size: 0.65em;
        font-weight: 300;
        fill: #eee;
      }

      .tooltip {
        width: 100%;
        position: relative;
        box-sizing: border-box;
        padding: 20px;
      }

      circle {
        cursor: pointer;
      }

    </style>
    <content></content>
    <svg id="chart"></svg> 
    <div id="info"></div> 
  </template> 
  
  <script>
    Polymer('th-line-graph', {
      chartData: { 
        data1: [
          {value: 1, tooltip: "This is a tooltip" },
          {value: 5, tooltip: "This is another tooltip" },
          {value: 2 },
          {value: 7 },
          {value: 5 },
          {value: 2, tooltip: "Not all points need tooltips" },
          {value: 1, tooltip: "This is a tooltip" },
          {value: 3 },
          {value: 8 },
          {value: 20, tooltip: "Here's an explanation of the spike..." },
          {value: 2 },
          {value: 5 },
          {value: 7 }
        ],
        data2: [ // not connected to chart yet
          {value: 11, tooltip: "This is a tooltip" },
          {value: 15, tooltip: "This is another tooltip" },
          {value: 5 },
          {value: 2 },
          {value: 6 },
          {value: 9, tooltip: "Not all points need tooltips" },
          {value: 5, tooltip: "This is a tooltip" },
          {value: 8 },
          {value: 12 },
          {value: 16 },
          {value: 4 },
          {value: 6 },
          {value: 9 }
        ]
        // data1: [1, 6, 2, 7, 5, 2, 1, 3, 8, 20, 2, 5, 7],
        // data2: [5, 2, 5, 8, 12, 15, 18, 10, 3, 14, 7, 5, 2]
      },
      init: function() {
        var that = this;
        var data = that.chartData.data1,
            w = that.chartWidth,
            h = that.chartHeight,
            margin = 18; // space btw labels and axis
        
        // TODO: refactor
        var maxValue = (function(){ 
              var max = 0;
              for (var i=0; i<data.length; i++){ 
                if (data[i].value > max) {
                  max = data[i].value;
                }
              }
              return max;
            })();

        var y = d3.scale.linear().domain([0, maxValue]).range([0 + margin, h - margin]),
            x = d3.scale.linear().domain([0, data.length]).range([0 + margin, w - margin]);
            
        // container
        var chart_svg = that.$.chart;
        var svg = d3.select(chart_svg)
          .attr("width", w)
          .attr("height", h);
     
        var g = svg.append("g")
          .attr("transform", "translate(0,"+ h +")");
        
        // line data
        var line = d3.svg.line()
          .x(function(d,i) { return x(i); })
          .y(function(d) { return -y(d.value); })
          .interpolate("cardinal");

        // x-axis
        g.append("line")
          .attr("x1", x(0))
          .attr("y1", -1 * y(0))
          .attr("x2", x(data.length))
          .attr("y2", -1 * y(0));
        
        // y-axis
        g.append("line")
          .attr("x1", x(0))
          .attr("y1", -1 * y(0))
          .attr("x2", x(0))
          .attr("y2", -1 * y(maxValue));

        // x labels
        g.selectAll(".xLabel")
          .data(x.ticks(5))// TODO: Replace with formula (number of labels)
          .enter().append("text")
          .attr("class", "xLabel")
          .text(String)
          .attr("x", function(d) { return x(d) })
          .attr("y", 0)
          .attr("text-anchor", "middle");
        
        // y labels
        g.selectAll(".yLabel")
          .data(y.ticks(4)) // TODO: Replace with formula (number of labels)
          .enter().append("text")
          .attr("class", "yLabel")
          .text(String)
          .attr("x", 0)
          .attr("y", function(d) { return -1 * y(d) })
          .attr("text-anchor", "right")
          .attr("dy", 4);
        
        // x tick marks
        g.selectAll(".xTicks")
          .data(x.ticks(5)) // TODO: Replace with formula (number of tickmarks)
          .enter().append("line")
          .attr("class", "xTicks")
          .attr("x1", function(d) { return x(d); })
          .attr("y1", -1 * y(0))
          .attr("x2", function(d) { return x(d); })
          .attr("y2", -1 * y(-0.5));
        
        // y tick marks
        g.selectAll(".yTicks")
          .data(y.ticks(4)) // TODO: Replace with formula (number of tickmarks)
          .enter().append("line")
          .attr("class", "yTicks")
          .attr("y1", function(d) { return -1 * y(d); })
          .attr("x1", x(-0.2))
          .attr("y2", function(d) { return -1 * y(d); })
          .attr("x2", x(0));
        
        // make variables accessible in other methods
        that.svg = svg;
        that.data = data;
        that.g = g;
        that.line = line;
        that.x = x;
        that.y = y;
      },
      reset: function() {
        var that = this;
        that.path      
          .transition()
          .duration(2000)
          .ease("linear")
          .attr("stroke-dashoffset", totalLength);
      },
      
      animate: function() {
        var that = this;
        var g = that.g,
            svg = that.svg,
            data = that.data
            line = that.line,
            x = that.x,
            y = that.y;

        var path = g.append("path")
            .attr("d", line(data))
            .attr("stroke", "white")
            .attr("stroke-width", "2.5")
            .attr("fill", "none");
        
        var totalLength = path.node().getTotalLength();
        
        path
          .attr("stroke-dasharray", totalLength + " " + totalLength)
          .attr("stroke-dashoffset", totalLength)
          .transition()
            .duration(3000)
            .ease("linear")
            .attr("stroke-dashoffset", 0);
        
        this.path = path;
      
        var tooltip_area = that.$.info;
        var tooltip = d3.select(tooltip_area)
          .append("div")   
          .attr("class", "tooltip");

        g.selectAll("circle")
          .data(data)
          .enter().append("circle")
          .attr("r", 0)
          .attr("fill", "#2a94cb") // Needs to be same as background
          .attr("stroke", "white")
          .attr("stroke-width", 2)
          .attr("cx", function(d,i) { return  x(i); })
          .attr("cy", function(d) { return -1 * y(d.value); })
          .on("mouseover", function(d) {      
            d3.select(this).transition().duration(500).attr("r", 4);
            tooltip.transition()        
                .duration(200)      
                .style("opacity", 1);      
            tooltip.html(d.tooltip);  
            })
          .on("mouseout", function(d) {
            d3.select(this).transition().duration(500).attr("r", 3);      
            tooltip.transition()        
                .duration(200)      
                .style("opacity", 0);      
            })
          .transition()
            .duration(500)
            .delay(3000)
            .attr("r", function(d){ 
              return (d.tooltip ? 3 : 0); // Only if datapoint has tooltip, a marker will be drawn
            }
          );

        // TODO
        // add color background to highlight part of the data?
        // progressively show more data by tapping next button?
        // add another series to the graph
        // restructure data accordingly
        // animate the axes - http://bl.ocks.org/mbostock/1166403
        // set specific values to x axis? (i.e. not the index)
        // make line style and chart style dynamic, as inputs
        // refactor
      }
    });
  </script>

</polymer-element>
