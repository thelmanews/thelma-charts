<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="th-d3-chart.html">

<polymer-element name="th-line-graph" extends="th-d3-chart">
  <template>
    <style>
      :host {
        font-size: 0.875em;
      }
       
      line {
        stroke: #386c9d;
        stroke-width: 2;
      }
      #chart {
        width: 100%;
        padding: 10px;
        box-sizing: border-box;
      }
      .xTicks, .yTicks {
        stroke: #386c9d;
      }

      .xLabel, .yLabel {
        font-size: 0.65em;
        font-weight: 300;
        fill: #eee;
      }

      .dot {

      }

    </style>
    <content></content>
    <svg id="chart"></svg> 
  </template> 
  
  <script>
    Polymer('th-line-graph', {
      chartData: { 
        data1: [1, 6, 2, 7, 5, 2, 1, 3, 8, 20, 2, 5, 7],
        data2: [5, 2, 5, 8, 12, 15, 18, 10, 3, 14, 7, 5, 2]
      },
      init: function() {
        var data = this.chartData.data1,
            w = this.chartWidth,
            h = this.chartHeight,
            margin = 18, // space btw labels and axis
            y = d3.scale.linear().domain([0, d3.max(data)]).range([0 + margin, h - margin]),
            x = d3.scale.linear().domain([0, data.length]).range([0 + margin, w - margin]);
        
        // container
        var chart_svg = this.$.chart;
        var svg = d3.select(chart_svg)
          .attr("width", w)
          .attr("height", h);
     
        var g = svg.append("g")
          .attr("transform", "translate(0,"+ h +")");
        
        // line data
        var line = d3.svg.line()
          .x(function(d,i) { return x(i); })
          .y(function(d) { return -y(d); })
          .interpolate("cardinal");

        // x-axis
        g.append("line")
          .attr("x1", x(0))
          .attr("y1", -1 * y(0))
          .attr("x2", x(data.length))
          .attr("y2", -1 * y(0));
        
        // y-axis
        g.append("line")
          .attr("x1", x(0))
          .attr("y1", -1 * y(0))
          .attr("x2", x(0))
          .attr("y2", -1 * y(d3.max(data)));

        // x labels
        g.selectAll(".xLabel")
          .data(x.ticks(5))// TODO: Replace with formula (number of labels)
          .enter().append("text")
          .attr("class", "xLabel")
          .text(String)
          .attr("x", function(d) { return x(d) })
          .attr("y", 0)
          .attr("text-anchor", "middle");
        
        // y labels
        g.selectAll(".yLabel")
          .data(y.ticks(4)) // TODO: Replace with formula (number of labels)
          .enter().append("text")
          .attr("class", "yLabel")
          .text(String)
          .attr("x", 0)
          .attr("y", function(d) { return -1 * y(d) })
          .attr("text-anchor", "right")
          .attr("dy", 4);
        
        // x tick marks
        g.selectAll(".xTicks")
          .data(x.ticks(5)) // TODO: Replace with formula (number of tickmarks)
          .enter().append("line")
          .attr("class", "xTicks")
          .attr("x1", function(d) { return x(d); })
          .attr("y1", -1 * y(0))
          .attr("x2", function(d) { return x(d); })
          .attr("y2", -1 * y(-0.5));
        
        // y tick marks
        g.selectAll(".yTicks")
          .data(y.ticks(4)) // TODO: Replace with formula (number of tickmarks)
          .enter().append("line")
          .attr("class", "yTicks")
          .attr("y1", function(d) { return -1 * y(d); })
          .attr("x1", x(-0.2))
          .attr("y2", function(d) { return -1 * y(d); })
          .attr("x2", x(0));
        
        // make variables accessible in other methods
        this.svg = svg;
        this.data = data;
        this.g = g;
        this.line = line;
        this.x = x;
        this.y = y;
      },
      reset: function() {
        path      
          .transition()
          .duration(2000)
          .ease("linear")
          .attr("stroke-dashoffset", totalLength);
      },
      
      animate: function() {
        var g = this.g,
            data = this.data,
            line = this.line,
            x = this.x,
            y = this.y;

        var path = g.append("path")
            .attr("d", line(data))
            .attr("stroke", "white")
            .attr("stroke-width", "2.5")
            .attr("fill", "none");
        
        var totalLength = path.node().getTotalLength();
        
        path
          .attr("stroke-dasharray", totalLength + " " + totalLength)
          .attr("stroke-dashoffset", totalLength)
          .transition()
            .duration(3000)
            .ease("linear")
            .attr("stroke-dashoffset", 0);
        
        this.path = path;

        g.selectAll(".dot")
          .data(data)
          .enter().append("circle")
          .attr("r", 0)
          .attr("fill", "#2a94cb") // needs to be same as background
          .attr("stroke", "white")
          .attr("stroke-width", 2)
          .attr("cx", function(d,i) { return  x(i); })
          .attr("cy", function(d) { return -1 * y(d); })
          .transition()
            .duration(500)
            .delay(3000)
            .attr("r", 4);
        


        // TODO
        // add select markers for certain datapoints, and animate
        // add tooltip for markers
        // add color background to highlight part of the data
        // progressively show more data by tapping next button
        // add another series to the graph
        // restructure data accordingly
      }
    });
  </script>

</polymer-element>
