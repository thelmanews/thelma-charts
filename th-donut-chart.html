<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="th-d3-chart.html">

<polymer-element name="th-donut-chart" extends="th-d3-chart">
  <template>
    <core-style ref="theme"></core-style>
    <style>

      :host {
        display: inline-block;
        position: relative;
      }
      #chart {

      }
      #chart text {
        font-size: 14px;
      }

      #data_errors {
        font-size: 14px;
        color: red;
        position: absolute;
        top: 0;
        left: 0;
      }
    </style>

      <svg id="chart"></svg>

      <ul id="data_errors">
      </ul>
  </template>
  <script>

      Polymer('th-donut-chart', {
        chartData: {value: 65},
        init: function() {
          var margin = {
                top : 8,
                right : 0,
                bottom : 10,
                left : 0,
                label: 3
            }, width = this.chartWidth*0.95 - margin.left - margin.right, height = this.chartHeight*0.95 - margin.top - margin.bottom,
            twoPi = 2 * Math.PI,
            progress = 0,
            total = 100,
            formatPercent = d3.format(".0%"),
            outerRadius = height*0.39,
            innerRadius = height*0.25;
            this._prevProgress = 0;

            this.height = height;

            var foreground, text, arc;


            arc = d3.svg.arc()
              .startAngle(0)
              .innerRadius(innerRadius)
              .outerRadius(outerRadius);


            var chart_svg = this.$.chart;

            var svg = d3.select(chart_svg);

            // adding shadow 

            // var defs = svg.append("defs");

            // var filter = defs.append("filter")
            //     .attr("id", "dropshadow")

            // filter.append("feGaussianBlur")
            //     .attr("in", "SourceAlpha")
            //     .attr("stdDeviation", 2)
            //     .attr("result", "blur");
            // filter.append("feOffset")
            //     .attr("in", "blur")
            //     .attr("dx", 1)
            //     .attr("dy", 1)
            //     .attr("result", "offsetBlur");

            // var feMerge = filter.append("feMerge");

            // feMerge.append("feMergeNode")
            //     .attr("in", "offsetBlur")
            // feMerge.append("feMergeNode")
            //     .attr("in", "SourceGraphic");



            var container = svg.attr("width", width)
                .attr("height", height)
                .append("g")
                .attr("transform", "translate(" +(width / 2 ) + "," + (height * 0.4) + ")");
            
            var meter = container.append("g")
                .attr("class", "progress-meter");
            
            meter.append("circle")
                .attr("class", "fill-background")
                .attr("r", outerRadius);

            
            meter.append("path")
                .attr("class", "fill-foreground")
                .attr("d", arc.endAngle(twoPi));
            
            foreground = meter.append("path")
                .attr("class", "data0");
                // .attr("filter", "url(#dropshadow)");
            
            text = meter.append("text")
                .attr('class','percent data0')
                .attr("text-anchor", "middle")
                .attr("dy", ".35em");

            this.foreground = foreground;
            this.formatPercent = formatPercent;
            this.arc = arc;
            this.twoPi = twoPi;
            this.text = text;


        },
        reset: function() {
            
            
        },
        
        animate: function() {

              var progress = this.chartData.value;
              var total = 100;
              var that = this;
              console.log('total');
              console.log(total);
              var i = d3.interpolate(that._prevProgress/total, progress/total);//d3.event.loaded / total);
              d3.transition().delay(1000).duration(1000).tween("progress", function() {
                return function(t) {
                  progress = i(t);
                  that.foreground.attr("d", that.arc.endAngle(that.twoPi * progress));
                  that.text.text(that.formatPercent(progress));
                };
              });

              this._prevProgress = progress; 
        },
        chartSpecificDataValidate: function() {
          // There should be a value specified.
          // The value should be between 1 and 100.

          var errors = [],
              currentVal = this.chartData.value;

          if(currentVal === undefined) {
            errors.push({input: currentVal, msg: 'Please provide a value for the chart.'});
          } else if (currentVal > 100 || currentVal < 1){
            errors.push({ input: currentVal, 
                          msg: currentVal + ' is invalid. You must enter a number between 1 and 100.', 
                          corrected: (function(){ return currentVal > 100 ? 100 : 1; })()});
          }
          
          return errors;
        }
        
      });



  </script>
</polymer-element>